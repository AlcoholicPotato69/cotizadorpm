<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Facturación - Plaza Mayor</title>
    
    <script src="../../assets/libs/js/tailwindcss.js"></script>
    <link rel="stylesheet" href="../../assets/libs/css/all.min.css">
    <script src="../js/hub-config.js"></script>
    <script src="../supabase.js"></script>
    
    <script>
        tailwind.config = { theme: { extend: { colors: { brand: { red: '#D32F2F', dark: '#1a1a1a', gray: '#f3f4f6' } } } } }
    </script>

    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f3f4f6; } 
        .hidden { display: none !important; } 
        .fade-in { animation: fadeIn 0.3s ease-out; } 
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } } 
        .custom-scroll::-webkit-scrollbar { width: 6px; } 
        .custom-scroll::-webkit-scrollbar-track { background: #f1f1f1; } 
        .custom-scroll::-webkit-scrollbar-thumb { background: #ccc; border-radius: 4px; } 
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        /* Contenedor PDF */
        .pdf-frame { width: 100%; height: 100%; border: none; background: #525659; }
    </style>
</head>
<body class="bg-brand-gray text-gray-800 flex flex-col min-h-screen relative">
    <div id="toast-container" class="fixed bottom-5 right-5 z-[70] flex flex-col gap-2"></div>
    
    <script>const TENANT_SCHEMA='finanzas';</script>
  <script src="../js/layout.js"></script>
    
    <nav class="bg-brand-red shadow-lg sticky top-16 z-40 border-t border-red-800">
        <div class="container mx-auto px-4 flex h-14 items-center text-white gap-2 overflow-x-auto no-scrollbar">
            <a href="catalog.html" class="px-4 py-1.5 rounded-full font-bold text-xs uppercase hover:bg-white/20 transition whitespace-nowrap"><i class="fa-solid fa-store"></i> Catálogo</a>
            <a href="agenda.html" class="px-4 py-1.5 rounded-full font-bold text-xs uppercase hover:bg-white/20 transition whitespace-nowrap"><i class="fa-solid fa-calendar-days"></i> Agenda</a>
            <a href="orders.html" class="px-4 py-1.5 rounded-full font-bold text-xs uppercase hover:bg-white/20 transition whitespace-nowrap"><i class="fa-solid fa-file-invoice-dollar"></i> Cotizaciones</a>
            <a href="contracts.html" class="px-4 py-1.5 rounded-full font-bold text-xs uppercase hover:bg-white/20 transition whitespace-nowrap"><i class="fa-solid fa-file-signature"></i> Contratos</a>
            <a href="invoices.html" class="bg-white/20 shadow-inner px-4 py-1.5 rounded-full font-bold text-xs uppercase flex items-center gap-2 whitespace-nowrap"><i class="fa-solid fa-file-invoice"></i> Facturas</a>            <a href="clientes.html" class="px-4 py-1.5 rounded-full text-xs font-bold uppercase hover:bg-white/20 transition whitespace-nowrap flex items-center gap-2"><i class="fa-solid fa-users"></i> Clientes</a>

            <a href="reports.html" class="px-4 py-1.5 rounded-full font-bold text-xs uppercase hover:bg-white/20 transition whitespace-nowrap"><i class="fa-solid fa-chart-pie"></i> Reportes</a>
            <div class="flex-grow"></div>
        </div>
    </nav>

    <main class="flex-grow container mx-auto px-4 md:px-6 py-6 md:py-8 max-w-7xl animate-enter">
        <div class="flex flex-col lg:flex-row gap-6 h-[calc(100vh-140px)]">
            
            <div class="w-full lg:w-1/3 flex flex-col bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden h-1/3 lg:h-auto">
                <div class="p-4 border-b border-gray-100 bg-gray-50 flex flex-col gap-3">
                    <h2 class="font-black text-gray-700 uppercase text-sm tracking-wide flex items-center gap-2">
                        <i class="fa-solid fa-list-check text-brand-red"></i> Pendientes de Factura
                    </h2>
                    <input type="text" id="search-orders" placeholder="Buscar cliente o folio..." class="w-full bg-white border border-gray-200 rounded-lg p-2 text-xs font-bold outline-none focus:border-brand-red">
                </div>
                <div id="orders-list" class="flex-grow overflow-y-auto custom-scroll p-2 space-y-2">
                    <div class="p-8 text-center text-gray-400 text-xs italic">Cargando...</div>
                </div>
            </div>

            <div class="w-full lg:w-2/3 flex flex-col gap-4 h-2/3 lg:h-auto">
                
                <div id="workspace-empty" class="bg-white h-full rounded-2xl shadow-sm border border-gray-200 flex flex-col items-center justify-center text-center h-full opacity-50">
                    <i class="fa-solid fa-file-invoice-dollar text-6xl text-gray-200 mb-4"></i>
                    <p class="text-sm font-bold uppercase">Selecciona una orden para validar su factura.</p>
                </div>

                <div id="workspace-active" class="hidden h-full flex-col bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden relative">
                    
                    <div id="loading-overlay" class="hidden absolute inset-0 bg-white/90 z-50 flex flex-col items-center justify-center">
                        <i class="fa-solid fa-circle-notch fa-spin text-4xl text-brand-red mb-3"></i>
                        <p class="text-xs font-bold uppercase text-gray-500">Procesando Documentos...</p>
                    </div>

                    <div class="bg-brand-dark text-white p-5 flex justify-between items-center shrink-0">
                        <div>
                            <p class="text-[10px] uppercase opacity-70 tracking-widest">Validación Fiscal</p>
                            <h2 id="wk-client" class="font-bold text-xl leading-tight">Cliente S.A.</h2>
                            <p id="wk-folio" class="text-xs font-mono text-brand-red">ORD-0000</p>
                        </div>
                        <div class="text-right">
                            <p class="text-3xl font-black" id="wk-total">$0.00</p>
                            <p class="text-[10px] uppercase opacity-80">Total Requerido (Cotización)</p>
                        </div>
                    </div>

                    <div class="flex-grow p-6 overflow-y-auto custom-scroll flex flex-col">
                        
                        <div id="upload-section" class="flex flex-col gap-6 h-full">
                            <div class="bg-yellow-50 border border-yellow-100 p-4 rounded-xl flex gap-3 items-start">
                                <i class="fa-solid fa-shield-halved text-yellow-500 mt-1 text-lg"></i>
                                <div class="text-xs text-yellow-800">
                                    <p class="font-bold uppercase mb-1">Reglas de Validación Automática:</p>
                                    <ul class="list-disc ml-4 space-y-1">
                                        <li>El <strong>Total del XML</strong> debe coincidir con el de la cotización ($<span id="target-amount">0.00</span>).</li>
                                        <li>Se actualizarán los datos fiscales en la orden (RFC Receptor, Folio Fiscal).</li>
                                        <li>Una vez guardada, la factura <strong>bloquea</strong> la edición de la orden.</li>
                                    </ul>
                                </div>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 flex-grow">
                                <label class="border-2 border-dashed border-gray-300 rounded-xl flex flex-col items-center justify-center p-6 hover:bg-gray-50 cursor-pointer transition group relative h-48 md:h-auto">
                                    <input type="file" id="file-xml" accept=".xml" class="hidden" onchange="window.handleFileSelect(this, 'xml')">
                                    <i class="fa-solid fa-file-code text-4xl text-gray-300 group-hover:text-orange-500 mb-3 transition"></i>
                                    <p class="text-sm font-bold text-gray-500">Subir XML</p>
                                    <p id="lbl-xml" class="text-[10px] text-gray-400 mt-1 max-w-[200px] truncate">No seleccionado</p>
                                    <div id="check-xml" class="hidden absolute top-3 right-3 text-green-500 text-xl animate-bounce"><i class="fa-solid fa-circle-check"></i></div>
                                </label>

                                <label class="border-2 border-dashed border-gray-300 rounded-xl flex flex-col items-center justify-center p-6 hover:bg-gray-50 cursor-pointer transition group relative h-48 md:h-auto">
                                    <input type="file" id="file-pdf" accept=".pdf" class="hidden" onchange="window.handleFileSelect(this, 'pdf')">
                                    <i class="fa-solid fa-file-pdf text-4xl text-gray-300 group-hover:text-red-500 mb-3 transition"></i>
                                    <p class="text-sm font-bold text-gray-500">Subir PDF</p>
                                    <p id="lbl-pdf" class="text-[10px] text-gray-400 mt-1 max-w-[200px] truncate">No seleccionado</p>
                                    <div id="check-pdf" class="hidden absolute top-3 right-3 text-green-500 text-xl animate-bounce"><i class="fa-solid fa-circle-check"></i></div>
                                </label>
                            </div>

                            <div class="flex justify-end pt-4 border-t border-gray-100">
                                <button onclick="window.validateAndSaveInvoice()" id="btn-save-invoice" disabled class="bg-gray-300 text-white px-8 py-3 rounded-xl font-bold text-xs uppercase shadow-none cursor-not-allowed transition flex items-center gap-2">
                                    <i class="fa-solid fa-lock"></i> Validar y Bloquear Orden
                                </button>
                            </div>
                        </div>

                        <div id="view-section" class="hidden flex-col h-full">
                            <div class="flex justify-between items-center mb-4 bg-green-50 p-4 rounded-xl border border-green-100 shrink-0">
                                <div class="flex items-center gap-3">
                                    <div class="bg-green-500 text-white w-10 h-10 rounded-full flex items-center justify-center shadow-sm"><i class="fa-solid fa-check text-lg"></i></div>
                                    <div>
                                        <p class="text-xs font-bold text-green-800 uppercase tracking-wide">Factura Validada y Vinculada</p>
                                        <p class="text-[10px] text-green-600 font-mono mt-0.5" id="view-uuid">UUID: ---</p>
                                    </div>
                                </div>
                                <button onclick="window.deleteInvoice()" class="bg-white border border-red-200 text-red-500 hover:bg-red-50 hover:text-red-600 w-10 h-10 rounded-xl transition flex items-center justify-center shadow-sm" title="Eliminar Factura (Desbloquear)"><i class="fa-solid fa-trash"></i></button>
                            </div>
                            
                            <div class="flex gap-4 mb-4 shrink-0">
                                <button onclick="window.downloadFile('xml')" class="flex-1 bg-orange-50 border border-orange-100 text-orange-700 py-2.5 rounded-xl text-xs font-bold uppercase hover:bg-orange-100 transition shadow-sm"><i class="fa-solid fa-file-code mr-2"></i> Descargar XML</button>
                                <button onclick="window.downloadFile('pdf')" class="flex-1 bg-red-50 border border-red-100 text-red-700 py-2.5 rounded-xl text-xs font-bold uppercase hover:bg-red-100 transition shadow-sm"><i class="fa-solid fa-file-pdf mr-2"></i> Descargar PDF</button>
                            </div>

                            <div class="flex-grow bg-gray-200 rounded-xl overflow-hidden border border-gray-300 relative shadow-inner">
                                <iframe id="pdf-viewer" class="pdf-frame" src=""></iframe>
                                <div id="no-pdf-msg" class="absolute inset-0 flex flex-col items-center justify-center text-gray-400 hidden">
                                    <i class="fa-solid fa-eye-slash text-4xl mb-2"></i>
                                    <span class="text-xs font-bold uppercase">Vista previa no disponible</span>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </main>

    <div id="generic-confirm-modal" class="fixed inset-0 bg-black/80 z-[110] hidden flex items-center justify-center p-4 backdrop-blur-sm animate-enter">
        <div class="bg-white w-full max-w-sm rounded-2xl shadow-2xl overflow-hidden p-6 text-center">
            <i class="fa-solid fa-circle-question text-4xl text-gray-300 mb-4"></i>
            <h3 class="font-bold text-lg mb-2 text-gray-800" id="confirm-title">¿Estás seguro?</h3>
            <div class="flex justify-center gap-3 mt-6">
                <button onclick="window.closeModal('generic-confirm-modal')" class="text-gray-500 hover:text-gray-800 text-xs font-bold px-4">Cancelar</button>
                <button id="btn-confirm-action" class="bg-brand-red text-white px-6 py-2 rounded-xl font-bold text-xs uppercase shadow-lg hover:bg-red-700 transition">Confirmar</button>
            </div>
        </div>
    </div>

    <script src="invoices.js"></script>
</body>
</html>